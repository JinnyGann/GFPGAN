name: Build GFPGAN Executable

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    # 1. Get source code and sub-dependencies
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    # 2. Download and Install Vulkan SDK using the robust command
    - name: Install Vulkan SDK
      shell: powershell
      run: |
        $vulkanUrl = "https://sdk.lunarg.com/sdk/download/1.3.275.0/windows/VulkanSDK-1.3.275.0-Installer.exe"
        $outputFile = "VulkanSDK-Installer.exe"
        Write-Host "Downloading Vulkan SDK from: $vulkanUrl"
        Invoke-WebRequest -Uri $vulkanUrl -OutFile $outputFile
        Write-Host "Download complete. Starting silent installation..."
        
        # This is the corrected command. It is more explicit and reliable for automation.
        Start-Process -FilePath $outputFile -ArgumentList '--confirm-command', 'install' -Wait
        
        Write-Host "Vulkan SDK installation finished."
      
    # 3. Add MSBuild (Visual Studio) to the PATH
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    # 4. Configure the project with CMake
    - name: Configure CMake
      run: cmake -S . -B build -DGFPGAN_BUILD_NCNN_VULKAN=ON

    # 5. Compile the C++ code into an .exe
    - name: Build Project with MSBuild
      run: msbuild build/GFPGAN.sln /p:Configuration=Release /p:Platform=x64

    # 6. Upload the final .exe and models for download
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gfpgan-ncnn-vulkan-windows
        path: |
          build/Release/gfpgan-ncnn-vulkan.exe
          models/
