name: Build GFPGAN Executable

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    # 1. Get source code and sub-dependencies
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    # 2. Install Vulkan SDK via Chocolatey (The Industry-Standard Method)
    # This is a robust package manager that handles finding and installing the SDK.
    - name: Install Vulkan SDK
      run: choco install vulkan-sdk --version=1.3.275.0 --no-progress -y

    # 3. Add MSBuild (Visual Studio) to the PATH
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    # 4. Configure the project with CMake
    # CMake will automatically find the Vulkan SDK installed by Chocolatey.
    - name: Configure CMake
      run: cmake -S . -B build -DGFPGAN_BUILD_NCNN_VULKAN=ON

    # 5. Compile the C++ code into an .exe
    - name: Build Project with MSBuild
      run: msbuild build/GFPGAN.sln /p:Configuration=Release /p:Platform=x64

    # 6. Upload the final .exe and models for download
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gfpgan-ncnn-vulkan-windows
        path: |
          build/Release/gfpgan-ncnn-vulkan.exe
          models/
