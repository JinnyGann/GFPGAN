name: Build GFPGAN Executable

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    # 1. Get source code and sub-dependencies
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    # 2. Download and Extract Vulkan SDK (Bypassing the Installer)
    - name: Install Vulkan SDK from ZIP
      shell: powershell
      run: |
        $vulkanZipUrl = "https://storage.googleapis.com/vulkan-sdks/1.3.275.0/VulkanSDK-1.3.275.0-windows.zip"
        $outputFile = "VulkanSDK.zip"
        $extractPath = "C:\VulkanSDK"

        Write-Host "Downloading Vulkan SDK ZIP from $vulkanZipUrl"
        Invoke-WebRequest -Uri $vulkanZipUrl -OutFile $outputFile

        Write-Host "Extracting Vulkan SDK to $extractPath"
        Expand-Archive -Path $outputFile -DestinationPath $extractPath
        
        $sdkPath = "$extractPath\1.3.275.0"
        Write-Host "Setting VULKAN_SDK environment variable to $sdkPath"
        echo "VULKAN_SDK=$sdkPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
        $binPath = "$sdkPath\Bin"
        Write-Host "Adding $binPath to the system PATH"
        echo $binPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

        Write-Host "Vulkan SDK setup complete."
      
    # 3. Add MSBuild (Visual Studio) to the PATH
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    # 4. Configure the project with CMake
    - name: Configure CMake
      run: cmake -S . -B build -DGFPGAN_BUILD_NCNN_VULKAN=ON

    # 5. Compile the C++ code into an .exe
    - name: Build Project with MSBuild
      run: msbuild build/GFPGAN.sln /p:Configuration=Release /p:Platform=x64

    # 6. Upload the final .exe and models for download
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gfpgan-ncnn-vulkan-windows
        path: |
          build/Release/gfpgan-ncnn-vulkan.exe
          models/
